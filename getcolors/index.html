<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>Document</title>

    <style>
        body{
            padding: 3em;
            font-family : sans-serif;
        }
        canvas{
        border: 1px solid black;
        }
        .container{
            display: flex;
        }
        #ui-controls{
            margin-left: 3em;
        }
        button{
            background: #225ee5;
            border: none;
            outline: none;
            color : white;
            padding: 10px 12px;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }
        button.small{
            padding: 12px;
            background: #e6e6e6;
            color: inherit;
        }
        button.disabled{
            background: #e6e6e6;
            color: gray;
            cursor: not-allowed;
        }
        button.primary{
            background-color: #225ee5;
            color: white;
        }
        .demos{
            margin-bottom: 10px;
        }
        .color-swatch{
            display: inline-block;
            vertical-align: middle;
            width: 25px;
            height: 25px;
            margin-right: 10px;
        }
    </style>
</head>
<body>

    <h1>FabricJs Demo: Get Canvas Colors</h1>
    <div class="container">
        <canvas id="c" width="600" height="600"></canvas>

        <div id="ui-controls">
        
            <button id="getColors" class="small primary">GET COLORS</button>
            <button id="addOneObject" class="small">ADD 1 OBJECT</button>
            <button id="addTwoObjects" class="small">ADD 2 OBJECTS</button>
            <button id="addImage" class="small">ADD IMAGE</button>
            <br/>
            <br/>
            <div id="canvasData">
                The colors in the canvas:
                <span></span>
            </div>
           
        </div>
     
    </div>




<script src="https://cdnjs.cloudflare.com/ajax/libs/fabric.js/2.2.2/fabric.js" ></script>
<!-- <script src="fabric.js" ></script> -->

<script>
    
    var canvas = new fabric.Canvas('c'),    
        baseUrl = "images/m2P5xz0.jpg",
        imgUrl = "images/q9aLMza.png",
        svgUrl = "images/ELEPHANT_C_4.svg",
        uiControlsContainer = document.getElementById('ui-controls'),
        btnGetColors = document.getElementById("getColors"),
        canvasDataContainer = document.getElementById("canvasData").querySelector('span'),
        btnAddOneObject = document.getElementById("addOneObject"),
        btnAddTwoObjects = document.getElementById("addTwoObjects"),
        btnAddImage = document.getElementById("addImage")
    ;

    // Set overrides
    fabric.Object.prototype.set({
        originX: "center",
        originY: "center",
        centeredScaling: true,
    })

    fabric.Canvas.prototype.set({
        preserveObjectStacking : true
    })


    function init(){

        canvas.on('object:modified', ()=> {
            console.log('object modified')
        })

        canvas.on('after:render', ()=> {
            console.log('after render')
        })


        btnGetColors.addEventListener('click', btnGetColorsHandler);
        btnAddOneObject.addEventListener('click', btnAddOneObjHandler);
        btnAddTwoObjects.addEventListener('click', btnAddTwoObjHandler);
        btnAddImage.addEventListener('click', btnAddImageHandler);
        
        // Add the objects
        addObjects();


    }

    Number.prototype.round = function(places) {
        return +(Math.round(this + "e+" + places)  + "e-" + places);
    }


    function btnAddOneObjHandler(){

        const text2 = new fabric.Text('FabricJs', {
            top : 350,
            left : 510,
            originX : 'center',
            originY : 'center',
            fill : 'green'
        });

        canvas.add(text2);
        canvas.renderAll();
    }
    function btnAddTwoObjHandler(){

        const text2 = new fabric.Text('FabricJs', {
            top : 450,
            left : 510,
            originX : 'center',
            originY : 'center',
            fill : 'yellow'
        });

        const img = new Image();
        img.onload = function(){
            const imgObj = new fabric.Image(img, {
                top : 400,
                left: 100
            });

            canvas.add(imgObj);
            // imgObj.center();
            canvas.add(text2);
            canvas.renderAll();
        }
        img.src = baseUrl;
    }

    function btnAddImageHandler(){

        const img = new Image();
        img.onload = function(){
            const imgObj = new fabric.Image(img, {
                top : 400,
                left: 100
            });

            imgObj.scale(.6);
            canvas.add(imgObj);
            imgObj.center();
            canvas.renderAll();
        }
        img.src = imgUrl;

    }

    function btnGetColorsHandler(e){
    
        canvas.discardActiveObject();
        canvas.renderAll();


        let executionTime;
        const timeStart = performance.now();
        const colors = getCanvasColors();
        const timeEnd = performance.now();
        executionTime = ( (timeEnd - timeStart) / 1000).round(4);

        printResults(colors, executionTime);
    }

    function printResults(colors, execTime){

        const listHtml = colors.map( color => `<li><span class="color-swatch" style="background-color: ${color}"></span> ${color}</li>` ).join('');
        const markup = ['<ul>', listHtml, '</ul>',
            `<p>Execution Time: 
                ${execTime}s
            </p>`
        ];

        canvasDataContainer.innerHTML = markup.join('');
    }

    function getCanvasColors(){

        const canvasColors = [];

        const ctx = canvas.getContext('2d');
        const imageData = ctx.getImageData(0,0,canvas.width, canvas.height).data;
        let countPixels = imageData.length / 4;

        debugger;


        // Loop through each pixel
        for(let i=0; i < countPixels; i++){
            const color = {
                r : imageData[i * 4],
                g : imageData[i * 4 + 1],
                b : imageData[i * 4 + 2],
                a : imageData[i * 4 + 3]
            };

            // Check if color is black transparent
            // In that case, we don't count it
            if(color.r === 0 && color.g === 0 && color.b === 0 && color.a === 0)
                continue;

            const colorString = colorToString(color);

            // Avoid duplicates
            if(canvasColors.indexOf(colorString) < 0){
                // New color                
                canvasColors.push(colorString);
            }

        }

        console.log(canvasColors);
        return canvasColors;

    }

    function colorToString(color){
        return `rgba(${color.r},${color.g},${color.b})`;
    }

    function addObjects(){

        const text1 = new fabric.Text('Testing', {
            top : 150,
            left : 120,
            originX : 'center',
            originY : 'center',
            fill : 'red'
        });

     

        const clipPoly = new fabric.Polygon([
                { x: 180, y: 10 },
                { x: 300, y: 50 },
                { x: 300, y: 180 },
                { x: 180, y: 220 }
            ], {
    
            left: 500,    
            top: 150,
            width: 200,
            height: 400,
            fill: 'blue' /* use transparent for no fill */
            // selectable: false
        });

        // canvas.add(clipRect1);
        canvas.add(clipPoly);
        // clipPoly.center();
    

        canvas.add(text1);
        canvas.renderAll();
    }




    // ================================================================
    // Demo 1 
    // ================================================================


    function loadDemo1(){
        canvas.clear();

         // Clip region 1
        const clipRect1 = new fabric.Rect({
            width : 100,
            height: 300,
            fill: '#DDD',
            // fill: 'transparent',
            opacity: 1, 
            stroke: 'black',
            strokeWidth: 0,
            // selectable: false,
            clipFor : 'cat',
            name : 'mask1',
            // statefullCache: true

        });

        // Clip region 2
        var clipPoly = new fabric.Polygon([
                { x: 180, y: 10 },
                { x: 300, y: 50 },
                { x: 300, y: 180 },
                { x: 180, y: 220 }
            ], {
    
            left: 0,    
            top: 0,
            width: 200,
            height: 400,
            fill: '#ddd', /* use transparent for no fill */
            strokeWidth: 0,
            name: 'mask2'
            // selectable: false
        });

        // canvas.add(clipRect1);
        canvas.add(clipPoly);
        // clipRect1.center();
        clipPoly.center();


        const circle = new fabric.Circle({
            radius : 120,
            clipName: 'mask2',
            originX : 'left',
            originY : 'top',
            strokeWidth: 0,
            top: 300,
            left: 5
        });

        
        canvas.add(circle)
        circle.center();



        objA = circle;
        objB = clipPoly;
        
    }
    // =======================================
    // Ends Demo 1 




    // Initialize
    init();
    
        
    
</script>
    
</body>
</html>